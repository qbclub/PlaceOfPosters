<script setup>
import { useDisplay } from 'vuetify'
import { getData, setData } from 'nuxt-storage/local-storage';
import { useRoute } from "vue-router";

let posterStore = usePoster()

const { mobile } = useDisplay()
let cols = ref('')

const wrapper = ref(null)
const route = useRoute();
let locationsStore = useLocations()




let handleScroll = async () => {
  let triggerHeight =
    wrapper.value.scrollTop + wrapper.value.offsetHeight + 5
  if (triggerHeight >= wrapper.value.scrollHeight) {
    triggerHeight = wrapper.value.scrollHeight
  }
  if (triggerHeight == wrapper.value.scrollHeight) {
    await posterStore.fetchPosters(posterStore.filter)
  }
}

let radio = computed(() => {
  if (mobile.value) {

    return [{ label: 1, value: 12 }, { label: 2, value: 6 }, { label: 3, value: 4 }]
  } else {

    return [{ label: 3, value: 4 }, { label: 4, value: 3 }, { label: 6, value: 2 }, { label: 12, value: 1 }]
  }
})

watch(cols, () => {
  setData("cols", cols.value, 30, 'd')
})
watch(mobile, () => {
  mobile.value ? cols.value = "6" : cols.value = "2"
})



onMounted(async () => {


  // if (getData("cols")) { cols.value = getData("cols") }
  // else { mobile.value ? cols.value = "6" : cols.value = "3" }

  if (process.client) {
    if (route.hash) {
       let id = route.hash.slice(1)
    let el = document.getElementById(id)
    el?.scrollIntoView()
    }
  }


  wrapper.value.addEventListener("scroll", handleScroll);

  if (posterStore.posters.length == 0) {
    let filter

    if (getData('filterForm')) {
      filter = getData('filterForm')
    }
    if (!locationsStore.location.length) {
      if (getData('location')) {
        locationsStore.location = getData('location')
      }
    }

    posterStore.page = 1
    await posterStore.fetchPosters(filter)
  }
})
</script>

<template>
  <div class="wrapper" ref="wrapper" style="overflow-x: hidden;">
  
      <!-- <v-radio-group inline class="d-flex justify-center" v-model="cols" color="accent">
        <v-radio v-for="item in radio" :value="item.value" label=""></v-radio>
      </v-radio-group> -->
 
    <v-container class="pt-0 d-flex justify-center ">
      <v-row class="justify-center flex-wrap mb-16 mt-2 w-100">
        <!-- <v-fade-transition group leave-absolute hide-on-leave> -->
        <v-col v-for="item of posterStore.posters" :key="item._id" cols="6" sm="4" md="3" lg="2" class="pa-1">
          <PosterCard :poster="item" :id='item._id' />
        </v-col>
        <!-- </v-fade-transition> -->
      </v-row>
    </v-container>
    <v-row class="justify-center">
      <v-col>
        <h3 class="text-center" v-if="!posterStore.posters.length && posterStore.isLoaded"> ÐœÑ‹ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ ðŸ˜Ÿ</h3>
      </v-col>
    </v-row>
    <v-row class="justify-center">
      <v-col v-show="!posterStore.isLoaded" cols="12" sm="4" class="ma-0 pa-0"> <v-progress-linear indeterminate
          color="accent"></v-progress-linear></v-col>

    </v-row>
  </div>
</template>

<style lang="scss" scoped>
.wrapper {

  height: 90dvh;
  overflow: auto;

  &::-webkit-scrollbar {
    display: none;
  }
}
</style>~/stores/poster~/stores/locations